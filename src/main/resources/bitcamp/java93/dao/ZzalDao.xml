<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="bitcamp.java93.dao.ZzalDao">
  
  <resultMap type="zzal" id="zzalMap">
    <id column="zzno" property="zzno"/>
    <result column="mno" property="mno"/>
    <result column="cno" property="cno"/>
    <result column="titl" property="title"/>
    <result column="pic2" property="mainPic"/>
    <result column="cdt2" property="cdt"/>
    <result column="ztmp" property="zzalTemporary"/>
    <result column="like_cnt" property="likeCount"/>
    <result column="reply_cnt" property="replyCount"/>
    <result column="rCount" property="rowCount"/>
    <association property="member" javaType="Member">
	    <id column="mno" property="no"/>
	    <result column="nick" property="nick"/>
	    <result column="email" property="email"/>
	    <result column="pwd" property="password"/>
	    <result column="mtype" property="membtype"/>
	    <result column="stype" property="signtype"/>
	    <result column="pic1" property="membpic"/>
	  </association>
	  <association property="zzallike" javaType="Zzallike">
	    <id column="zzno" property="zzno"/>
	    <result column="mno" property="mno"/>
	    <result column="cdt1" property="cdt"/>
	  </association>
  </resultMap>
  
	<select id="selectList" resultMap="zzalMap" parameterType="int">
    SELECT z.zzno, z.mno, m.nick, z.cno, z.titl, z.zpic, z.cdt as cdt2
    FROM zzal_lect z INNER JOIN memb m ON z.mno = m.mno
    WHERE z.zzno = #{no} 
  </select>

  <select id="zzalListWithCount" resultMap="zzalMap" parameterType="map">
    SELECT z.zzno, z.mno, m.nick, m.pic as pic1, z.cno, z.titl, z.pic as pic2, z.cdt as cdt2, 
    (SELECT count(*) FROM lik WHERE zzno=z.zzno) as like_cnt, 
    (SELECT count(*) FROM reply WHERE zzno=z.zzno) as reply_cnt
    FROM zzal_lect z INNER JOIN memb m on z.mno = m.mno
    WHERE z.ztmp=false
    ORDER BY like_cnt + reply_cnt desc
    LIMIT #{startIndex}, #{pageSize}
  </select>
  
  <select id="zzalLikeRank" resultMap="zzalMap" parameterType="map">
    SELECT z.zzno, z.mno, m.nick, m.pic as pic1, z.cno, z.titl, z.pic as pic2, z.cdt as cdt2,
    (SELECT count(*) FROM lik WHERE zzno=z.zzno) as like_cnt
    FROM zzal_lect z INNER JOIN memb m on z.mno = m.mno
    WHERE z.ztmp=false
    ORDER BY like_cnt desc
    LIMIT 30
  </select>

  <select id="zzalBestList" resultMap="zzalMap" parameterType="map">
    SELECT *
		FROM 
		    (SELECT z.zzno, z.titl, z.pic as pic2, m.nick FROM zzal_lect z INNER JOIN memb m ON z.mno = m.mno) t1
		LEFT JOIN
		    (SELECT zzno, cdt, count(*) as week_like FROM lik WHERE cdt Between AddDate(Now(),-7) AND Now() GROUP BY zzno) t2
		ON
		    t1.zzno = t2.zzno
		WHERE week_like IS NOT NULL
		ORDER BY week_like DESC
		LIMIT 10
  </select>
  
  <select id="countAll" resultType="int">
    SELECT count(*)
    FROM zzal_lect
  </select>
  
  <!-- index.html에서 짤강의 리스트 뿌릴 때, 해당 조건에 맞는 짤강의가 몇개인지 알아내기  -->
  <select id="foundRows" resultType="int">
    SELECT count(*) FROM(
    SELECT zzno,
    (SELECT count(*) FROM lik WHERE zzno=z.zzno) as like_cnt, 
    (SELECT count(*) FROM reply WHERE zzno=z.zzno) as reply_cnt
    FROM zzal_lect z INNER JOIN memb m on z.mno = m.mno
    WHERE z.ztmp=false
    ORDER BY like_cnt + reply_cnt desc) as rowCount
  </select>
  
</mapper> 




